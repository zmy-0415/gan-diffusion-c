cmake_minimum_required(VERSION 3.10)
project(main C)

# ========== åŸºç¡€é…ç½® ==========
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)

# è°ƒè¯•/å‘å¸ƒæ¨¡å¼ä¼˜åŒ–
if(CMAKE_BUILD_TYPE STREQUAL "Release")
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -O3 -march=native -lm")
else()
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -g -O0 -lm")
endif()

# ========== ç¦ç”¨ WebP ä¾èµ–ï¼ˆæ ¸å¿ƒï¼‰ ==========
set(SDL2IMAGE_BUILD_WEBP OFF CACHE BOOL "Disable WebP support")
set(SDL2IMAGE_USE_WEBP OFF CACHE BOOL "Disable WebP usage")
set(webp_FOUND ON CACHE BOOL "Fake WebP found to skip check")

# ========== ç¯å¢ƒæ£€æµ‹ï¼ˆUCRT64/MinGW64ï¼‰ ==========
set(MSYS2_UCRT64 OFF)
if(MINGW AND CMAKE_HOST_SYSTEM_NAME STREQUAL "Windows")
    if(DEFINED ENV{MSYSTEM} AND "$ENV{MSYSTEM}" STREQUAL "UCRT64")
        set(MSYS2_UCRT64 ON)
        set(SDL2_PREFIX "/ucrt64")
    else()
        set(SDL2_PREFIX "/mingw64")
    endif()
    set(CMAKE_PREFIX_PATH ${CMAKE_PREFIX_PATH} ${SDL2_PREFIX})
endif()

# ========== SDL2 + SDL2_image æŸ¥æ‰¾ ==========
find_package(SDL2 REQUIRED)
if(NOT SDL2_FOUND)
    message(FATAL_ERROR "SDL2 æœªæ‰¾åˆ°ï¼è¯·å®‰è£…ï¼špacman -S mingw-w64-ucrt-x86_64-SDL2")
endif()

# æ‰‹åŠ¨æŒ‡å®š SDL2_image è·¯å¾„
set(SDL2_IMAGE_INCLUDE_DIRS "${SDL2_PREFIX}/include/SDL2")
set(SDL2_IMAGE_LIBRARIES "${SDL2_PREFIX}/lib/libSDL2_image.dll.a")
if(NOT EXISTS ${SDL2_IMAGE_LIBRARIES})
    message(FATAL_ERROR "SDL2_image æœªæ‰¾åˆ°ï¼è¯·å®‰è£…ï¼špacman -S mingw-w64-ucrt-x86_64-SDL2_image")
endif()

# ========== å¤´æ–‡ä»¶ + æºæ–‡ä»¶ ==========
include_directories(
    ${PROJECT_SOURCE_DIR}/include
    ${SDL2_INCLUDE_DIRS}
    ${SDL2_IMAGE_INCLUDE_DIRS}
)

set(SOURCES
    src/game.c
    src/common.c
    src/ImageManager.c
)

add_executable(main src/main.c ${SOURCES})

# ========== é“¾æ¥åº“ ==========
target_link_libraries(main
    PRIVATE
    ${SDL2_LIBRARIES}
    ${SDL2_IMAGE_LIBRARIES}
)

# Windows ä¸“å±é…ç½®
if(WIN32)
    target_link_libraries(main PRIVATE SDL2main user32)
    set_target_properties(main PROPERTIES WIN32_EXECUTABLE ON) # éšè—æ§åˆ¶å°

    # æ‹·è´å¿…è¦ DLL
    set(REQUIRED_DLLS
        "${SDL2_PREFIX}/bin/SDL2.dll"
        "${SDL2_PREFIX}/bin/SDL2_image.dll"
        "${SDL2_PREFIX}/bin/libpng16-16.dll"
        "${SDL2_PREFIX}/bin/libjpeg-8.dll"
        "${SDL2_PREFIX}/bin/zlib1.dll"
    )
    foreach(DLL ${REQUIRED_DLLS})
        if(EXISTS ${DLL})
            add_custom_command(TARGET main POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different ${DLL} $<TARGET_FILE_DIR:main>
                COMMENT "æ‹·è´ DLL: ${DLL}"
            )
        endif()
    endforeach()
endif()

# Linux/macOS é€‚é…
if(UNIX AND NOT APPLE)
    target_link_libraries(main PRIVATE pthread m)
elseif(APPLE)
    include_directories(/usr/local/include/SDL2)
    link_directories(/usr/local/lib)
    target_link_libraries(main PRIVATE SDL2 SDL2_image "-framework Cocoa")
endif()

# ========== ä¿®å¤ï¼šAsset ç›®å½•åŒæ­¥ï¼ˆæ— å¾ªç¯ä¾èµ–ï¼‰ ==========
# 1. å®šä¹‰ asset æºç›®å½•å’Œç›®æ ‡ç›®å½•ï¼ˆæ³¨æ„ï¼šä½ åŸé…ç½®æ˜¯ assetsï¼Œç»Ÿä¸€ä¸º assetsï¼‰
set(ASSET_SOURCE_DIR "${PROJECT_SOURCE_DIR}/assets")
set(ASSET_TARGET_DIR "$<TARGET_FILE_DIR:main>/assets")

# 2. ä»…ä¿ç•™ã€Œç¼–è¯‘åæ‹·è´ã€é€»è¾‘ï¼ˆæ— å¾ªç¯ä¾èµ–ï¼‰
if(EXISTS ${ASSET_SOURCE_DIR})
    # æ ¸å¿ƒï¼šç¼–è¯‘åè‡ªåŠ¨æ‹·è´æ•´ä¸ª assets ç›®å½•ï¼ˆæ— ä¾èµ–å¾ªç¯ï¼‰
    add_custom_command(
        TARGET main POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_directory
        ${ASSET_SOURCE_DIR} ${ASSET_TARGET_DIR}
        COMMENT "ğŸ“‚ åŒæ­¥ Assets ç›®å½•ï¼š${ASSET_SOURCE_DIR} â†’ ${ASSET_TARGET_DIR}"
    )

    # å¯é€‰ï¼šç›‘å¬ assets æ–‡ä»¶å˜åŒ–ï¼ˆæ‰‹åŠ¨æ‰§è¡Œ make sync_assets åŒæ­¥ï¼Œæ— å¾ªç¯ä¾èµ–ï¼‰
    file(GLOB_RECURSE ASSET_FILES ${ASSET_SOURCE_DIR}/*)
    add_custom_target(
        sync_assets  # ç§»é™¤ ALL å…³é”®å­—ï¼Œé¿å…éšå¼ä¾èµ– main
        COMMAND ${CMAKE_COMMAND} -E copy_directory
        ${ASSET_SOURCE_DIR} ${ASSET_TARGET_DIR}
        COMMENT "ğŸ”„ æ‰‹åŠ¨åŒæ­¥ Assets ç›®å½•"
    )

    # å¯é€‰ï¼šæ‰“å° asset è·¯å¾„ï¼ˆè°ƒè¯•ç”¨ï¼‰
    message(STATUS "ğŸ“Œ Asset æºç›®å½•: ${ASSET_SOURCE_DIR}")
    message(STATUS "ğŸ“Œ Asset ç›®æ ‡ç›®å½•: ${ASSET_TARGET_DIR}")
else()
    message(WARNING "âš ï¸ Assets ç›®å½•ä¸å­˜åœ¨: ${ASSET_SOURCE_DIR}")
endif()